{
  "hash": "13555c0dfe08d150a52790ceb643e5cf",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"ggplot2 layers\"\nsubtitle: \"Lecture 6\"\ntitle-slide-attributes:\n  data-background-image: ../vizdata-bg.png\n  data-background-size: stretch\n  data-slide-number: none\nformat: revealjs\n---\n\n\n::: {.cell}\n\n:::\n\n\n# The layered grammar of graphics\n\n## Data: Flights from NYC in 2013\n\nWe will be using the `nycflights13::flights` dataset. This dataset contains information about all flights that departed from New York City (EWR, LGA, JFK) in 2013.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nglimpse(flights)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 336,776\nColumns: 19\n$ year           <int> 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2…\n$ month          <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…\n$ day            <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…\n$ dep_time       <int> 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 558, …\n$ sched_dep_time <int> 515, 529, 540, 545, 600, 558, 600, 600, 600, 600, 600, …\n$ dep_delay      <dbl> 2, 4, 2, -1, -6, -4, -5, -3, -3, -2, -2, -2, -2, -2, -1…\n$ arr_time       <int> 830, 850, 923, 1004, 812, 740, 913, 709, 838, 753, 849,…\n$ sched_arr_time <int> 819, 830, 850, 1022, 837, 728, 854, 723, 846, 745, 851,…\n$ arr_delay      <dbl> 11, 20, 33, -18, -25, 12, 19, -14, -8, 8, -2, -3, 7, -1…\n$ carrier        <chr> \"UA\", \"UA\", \"AA\", \"B6\", \"DL\", \"UA\", \"B6\", \"EV\", \"B6\", \"…\n$ flight         <int> 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301, 4…\n$ tailnum        <chr> \"N14228\", \"N24211\", \"N619AA\", \"N804JB\", \"N668DN\", \"N394…\n$ origin         <chr> \"EWR\", \"LGA\", \"JFK\", \"JFK\", \"LGA\", \"EWR\", \"EWR\", \"LGA\",…\n$ dest           <chr> \"IAH\", \"IAH\", \"MIA\", \"BQN\", \"ATL\", \"ORD\", \"FLL\", \"IAD\",…\n$ air_time       <dbl> 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149, 1…\n$ distance       <dbl> 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 733, …\n$ hour           <dbl> 5, 5, 5, 5, 6, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 6, 6…\n$ minute         <dbl> 15, 29, 40, 45, 0, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 0…\n$ time_hour      <dttm> 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-01 0…\n```\n\n\n:::\n:::\n\n\n## A simple scatterplot {.smaller}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = flights, mapping = aes(x = dep_delay, y = arr_delay)) +\n  geom_point()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/simple-plot-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n\n## Adding layers\n\nA plot is composed of layers. Each layer has:\n\n- A **geom**: The geometric object that represents the data (e.g., points, lines, bars).\n- An **aesthetic mapping**: How variables are mapped to visual properties.\n- A **stat**: A statistical transformation (e.g., counting, summarizing).\n- A **position adjustment**: How to arrange elements that would otherwise overlap.\n\n## Adding a layer: Trend line with `geom_smooth()` {.smaller}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = flights, mapping = aes(x = dep_delay, y = arr_delay)) +\n  geom_point(alpha = 0.1) +\n  geom_smooth()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = \"cs\")'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing non-finite outside the scale range\n(`stat_smooth()`).\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/smooth-plot-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n# Aesthetic Mappings\n\n## Global vs. Local Mappings\n\n-  Aesthetic mappings can be: \n  - Global: specify in `ggplot()` so they apply to all layers\n  - Local: specify in each `geom_*()` so they apply only to that layer\n\n## Using `color` as a local aesthetic\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = flights, mapping = aes(x = dep_delay, y = arr_delay)) +\n  geom_point(mapping = aes(color = origin), alpha = 0.1) +\n  geom_smooth()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = \"cs\")'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing non-finite outside the scale range\n(`stat_smooth()`).\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/local-aes-plot-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n## Why isn't this plot blue?\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# This is probably not what you want\nggplot(flights, aes(x = dep_delay, y = arr_delay)) +\n  geom_point(aes(color = \"blue\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/unnamed-chunk-2-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n## Setting vs. Mapping\n\n- To apply a constant property to all points, set it outside of `aes()`\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(flights, aes(x = dep_delay, y = arr_delay)) +\n  geom_point(color = \"blue\", alpha = 0.1)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/unnamed-chunk-3-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n# Geoms\n\n## Common geoms\n\n- `geom_point()`: Scatterplots\n- `geom_line()`: Line charts\n- `geom_bar()`: Bar charts\n- `geom_histogram()`: Histograms\n- `geom_boxplot()`: Boxplots\n- `geom_smooth()`: Trend lines\n- `geom_density()`: Density plots\n- [Many more!](ttps://ggplot2.tidyverse.org/reference/index.html#geom)\n\n\n# Statistical Transformations\n\n## `geom_bar` vs `geom_col`\n\n- `geom_bar()` uses `stat_count()` by default to count the number of observations for each category\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = flights, mapping = aes(x = carrier)) +\n  geom_bar()\n```\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/bar-chart-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n## Changing the `stat` argument\n\n- You can change the statistical transformation used by a geom with the `stat` argument...\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncarrier_counts <- flights |>\n  count(carrier) |> \n  ggplot(mapping = aes(x = carrier, y = n)) +\n    geom_bar(stat = \"identity\")\n```\n:::\n\n\n## Changing the stat\n\n- Using `after_stat()` to modify computed variables from a stat\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = flights) +\n  geom_bar(mapping = aes(x = carrier, y = after_stat(prop))) +\n  labs(y = \"Proportion\")\n```\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/unnamed-chunk-5-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n## Practice\n\nLet's try to overlay a density plot on top of a histogram of `dep_delay`...\n\n\n# Position Adjustments\n\n## Overplotting\n\n- Overplotting: When many points overlap in a scatterplot, making it hard to see the distribution of points\n- Common solution: Use transparency with `alpha` aesthetic\n- Another solution: Use position adjustments to spread out points\n\n## Jittering points\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(patchwork)\np1 <- ggplot(flights, aes(x = month, y = dep_delay)) +\n  geom_point(alpha = 0.01)\np2 <- ggplot(flights, aes(x = month, y = dep_delay)) +\n  geom_jitter(alpha = 0.01)\np1 + p2\n```\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/unnamed-chunk-6-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n\n## Bar chart adjustments\n\nFor bar charts, you can use `position` to change how bars are arranged.\n- `stack` (default): Stack bars on top of each other.\n- `fill`: Stack bars, but standardize to have the same height. Good for comparing proportions.\n- `dodge`: Place bars next to each other.\n\n## Bar chart adjustments\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 <- ggplot(flights, aes(x = carrier, fill = origin)) +\n  geom_bar(position = \"stack\")\np2 <- ggplot(flights, aes(x = carrier, fill = origin)) +\n  geom_bar(position = \"fill\") +\n  labs(y = \"Proportion\")\np3 <- ggplot(flights, aes(x = carrier, fill = origin)) +\n  geom_bar(position = \"dodge\")\np1 + p2 + p3\n```\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/unnamed-chunk-7-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n\n# Facets\n\n## `facet_wrap`\n\n- Facets allow you to break your plot into subplots based on a categorical variable.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = flights, mapping = aes(x = dep_delay, y = arr_delay)) +\n  geom_point(alpha = 0.1) +\n  facet_wrap(~ origin, nrow = 1)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/facet-plot-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n## Adding a trend line to facets\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = flights, mapping = aes(x = dep_delay, y = arr_delay)) +\n  geom_point(alpha = 0.1) +\n  geom_smooth() +\n  facet_wrap(~ origin, nrow = 1)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = \"cs\")'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing non-finite outside the scale range\n(`stat_smooth()`).\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/facet-smooth-plot-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n## Facet Grids\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = flights, mapping = aes(x = dep_delay, y = arr_delay)) +\n  geom_point(alpha = 0.1) +\n  geom_smooth() +\n  facet_grid(carrier ~ origin)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = \"cs\")'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing non-finite outside the scale range\n(`stat_smooth()`).\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Failed to fit group -1.\nCaused by error in `smooth.construct.cr.smooth.spec()`:\n! x has insufficient unique values to support 10 knots: reduce k.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 9430 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/facet-smooth-plot-2-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n# Coordinate Systems\n\n## Flipping coordinates\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 <- ggplot(data = flights, mapping = aes(x = carrier)) +\n  geom_bar()\n\np2 <- ggplot(data = flights, mapping = aes(x = carrier)) +\n  geom_bar() +\n  coord_flip()\np1 + p2\n```\n\n::: {.cell-output-display}\n![](06-layers_files/figure-revealjs/unnamed-chunk-8-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n\n## The layered grammar in summary\n\n```text\n`ggplot(data = <DATA>) +`\n`  <GEOM_FUNCTION>(`\n`    mapping = aes(<AESTHETIC_MAPPINGS>),`\n`    stat = <STAT>,`\n`    position = <POSITION>`\n`  ) +`\n`  <COORDINATE_SYSTEM> +`\n`  <FACET_FUNCTION>`\n```",
    "supporting": [
      "06-layers_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}